generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model access_grants {
  id                 String            @id
  client_id          String
  org_id             String?
  attorney_user_id   String?
  status             AccessGrantStatus
  granted_by_user_id String?
  granted_at         DateTime          @default(now())
  revoked_at         DateTime?
  users              User?             @relation("AttorneyAccess", fields: [attorney_user_id], references: [id], onDelete: Cascade)
  clients            clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  organizations      organizations?    @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([client_id, org_id])
  @@index([attorney_user_id])
  @@index([client_id])
  @@index([org_id])
}

model attorney_client_access {
  id              String         @id
  attorney_id     String
  client_id       String
  organization_id String?
  granted_at      DateTime       @default(now())
  revoked_at      DateTime?
  is_active       Boolean        @default(true)
  users           User           @relation("AttorneyAccess", fields: [attorney_id], references: [id], onDelete: Cascade)
  clients         clients        @relation(fields: [client_id], references: [id], onDelete: Cascade)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([attorney_id, client_id])
}

model audit_logs {
  id            String         @id
  user_id       String?
  org_id        String?
  client_id     String?
  policy_id     String?
  action        AuditAction
  message       String
  created_at    DateTime       @default(now())
  clients       clients?       @relation(fields: [client_id], references: [id])
  organizations organizations? @relation(fields: [org_id], references: [id])
  policies      policies?      @relation(fields: [policy_id], references: [id])
  users         User?          @relation(fields: [user_id], references: [id])

  @@index([client_id])
  @@index([created_at])
  @@index([org_id])
  @@index([policy_id])
  @@index([user_id])
}

model beneficiaries {
  id                   String                 @id
  client_id            String
  first_name           String
  last_name            String
  relationship         String?
  email                String?
  phone                String?
  date_of_birth        DateTime?              @db.Date
  created_at           DateTime               @default(now())
  updated_at           DateTime
  address_line1        String?
  address_line2        String?
  city                 String?
  state                String?
  postal_code          String?
  country              String?
  clients              clients                @relation(fields: [client_id], references: [id], onDelete: Cascade)
  policy_beneficiaries policy_beneficiaries[]

  @@index([first_name, last_name, date_of_birth])
  @@index([address_line1, city, state, postal_code])
  @@index([client_id])
}

model client_invites {
  id                 String            @id
  client_id          String
  token              String            @unique
  email              String
  expires_at         DateTime
  used_at            DateTime?
  created_at         DateTime          @default(now())
  updated_at         DateTime
  invited_by_user_id String?
  clients            clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  users              User?            @relation("ClientInviteInviter", fields: [invited_by_user_id], references: [id])
  submissions        submissions[]
  receipts           receipts[]
  client_versions     client_versions[]
}

model clients {
  id                     String                   @id
  email                  String
  first_name             String
  last_name              String
  phone                  String?
  date_of_birth          DateTime?                @db.Date
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  user_id                String?                  @unique
  org_id                 String?
  drivers_license        String?
  maiden_name            String?
  passport_number        String?
  ssn_last_4             String?
  client_fingerprint     String?                  @unique
  address_line1          String?
  address_line2          String?
  city                   String?
  state                  String?
  postal_code            String?
  country                String?
  access_grants          access_grants[]
  attorney_client_access attorney_client_access[]
  audit_logs             audit_logs[]
  beneficiaries          beneficiaries[]
  client_invites         client_invites[]
  organizations          organizations?           @relation(fields: [org_id], references: [id])
  users                  User?                    @relation("UserClient", fields: [user_id], references: [id])
  documents              documents[]
  policies               policies[]
  submissions            submissions[]
  receipts               receipts[]
  client_versions        client_versions[]

  @@unique([email])
  @@index([first_name, last_name, date_of_birth])
  @@index([address_line1, city, state, postal_code])
  @@index([client_fingerprint])
  @@index([org_id])
}

model documents {
  id                  String           @id
  client_id           String
  submission_id       String?
  policy_id           String?
  registry_version_id String?
  file_name           String
  file_type           String
  file_size           Int
  file_path           String
  mime_type           String
  uploaded_via        String?
  extracted_data      Json?
  ocr_confidence       Int?
  document_hash        String
  verified_at         DateTime?
  verified_by_user_id String?
  verification_notes  String?
  created_at          DateTime         @default(now())
  updated_at          DateTime
  clients             clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  policies            policies?          @relation(fields: [policy_id], references: [id])
  submissions         submissions?      @relation(fields: [submission_id], references: [id], onDelete: SetNull)
  registry_versions    registry_versions? @relation(fields: [registry_version_id], references: [id], onDelete: SetNull)
  users               User?             @relation("DocumentVerifier", fields: [verified_by_user_id], references: [id])

  @@index([client_id])
  @@index([created_at])
  @@index([policy_id])
  @@index([submission_id])
  @@index([document_hash])
  @@index([registry_version_id])
}

model insurers {
  id            String     @id
  name          String
  contact_phone String?
  contact_email String?
  website       String?
  created_at    DateTime   @default(now())
  updated_at    DateTime
  policies      policies[]
}

model invites {
  id              String         @id
  token           String         @unique
  attorney_id     String
  organization_id String?
  client_email    String
  status          InviteStatus   @default(pending)
  expires_at      DateTime
  accepted_at     DateTime?
  created_at      DateTime       @default(now())
  users           User           @relation("AttorneyInvites", fields: [attorney_id], references: [id], onDelete: Cascade)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

model org_members {
  id              String        @id
  user_id         String
  organization_id String
  role            OrgRole       @default(ATTORNEY)
  created_at      DateTime      @default(now())
  updated_at      DateTime
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  users           User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, organization_id])
}

model organizations {
  id                     String                   @id
  name                   String
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  slug                   String                   @unique
  address_line1          String?
  address_line2          String?
  city                   String?
  state                  String?
  postal_code            String?
  country                String?
  phone                  String?
  logo_url               String?
  billing_plan           BillingPlan              @default(FREE)
  billing_status         String?
  stripe_customer_id     String?
  stripe_subscription_id String?
  access_grants          access_grants[]
  attorney_client_access attorney_client_access[]
  audit_logs             audit_logs[]
  clients                clients[]
  invites                invites[]
  org_members            org_members[]
}

model policies {
  id                  String                 @id
  client_id           String
  insurer_id          String?
  carrier_name_raw    String?
  carrier_confidence  Float?
  policy_number       String?
  policy_type         String?
  verification_status PolicyVerificationStatus @default(PENDING)
  verified_at         DateTime?
  verified_by_user_id String?
  verification_notes  String?
  document_hash       String?
  created_at          DateTime               @default(now())
  updated_at          DateTime
  audit_logs          audit_logs[]
  documents           documents[]
  clients             clients                @relation(fields: [client_id], references: [id], onDelete: Cascade)
  insurers            insurers?              @relation(fields: [insurer_id], references: [id], onDelete: SetNull)
  users               User?                  @relation("PolicyVerifier", fields: [verified_by_user_id], references: [id])
  policy_beneficiaries policy_beneficiaries[]
}

model policy_beneficiaries {
  id             String        @id
  policy_id      String
  beneficiary_id String
  created_at     DateTime      @default(now())
  beneficiaries  beneficiaries @relation(fields: [beneficiary_id], references: [id], onDelete: Cascade)
  policies       policies      @relation(fields: [policy_id], references: [id], onDelete: Cascade)

  @@unique([policy_id, beneficiary_id])
}

model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique @map("clerkId")
  email         String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  role          UserRole @default(attorney)
  roles         String[] @default(["USER"])
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  barNumber     String?  @map("bar_number")
  address_line1 String?  @map("address_line1")
  address_line2 String?  @map("address_line2")
  city          String?  @map("city")
  state         String?  @map("state")
  postal_code   String?  @map("postal_code")
  country       String?  @map("country")
  phone         String?  @map("phone")

  orgMemberships       org_members[]
  attorneyClientAccess attorney_client_access[] @relation("AttorneyAccess")
  invites              invites[]                @relation("AttorneyInvites")
  clientInvites        client_invites[]         @relation("ClientInviteInviter")
  accessGrants         access_grants[]          @relation("AttorneyAccess")
  clientRecord         clients?                 @relation("UserClient")
  auditLogs            audit_logs[]
  attorneyProfile      attorneyProfile?
  apiTokens            ApiToken[]
  verifiedDocuments    documents[]              @relation("DocumentVerifier")
  verifiedPolicies     policies[]               @relation("PolicyVerifier")
  accessLogs           access_logs[]

  @@index([firstName, lastName])
  @@index([address_line1, city, state, postal_code])
  @@map("users")
}

model attorneyProfile {
  id                  String        @id @default(uuid())
  userId              String        @unique
  licenseStatus       LicenseStatus @default(PENDING)
  licenseState        String?       @map("license_state")
  verifiedAt          DateTime?
  appliedAt           DateTime      @default(now())
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  lawFirm             String?       @map("law_firm")
  licenseDocumentPath String?       @map("license_document_path")
  licenseDocumentName String?       @map("license_document_name")
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attorney_profiles")
}

model ApiToken {
  id           String    @id @default(uuid())
  name         String
  hash         String    @unique
  scopes       String[]
  createdById  String
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  revokedAt    DateTime?
  lastUsedAt   DateTime?
  lastUsedIp   String?
  lastUsedPath String?

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([expiresAt])
  @@index([revokedAt])
  @@index([lastUsedAt])
  @@map("api_tokens")
}

enum AccessGrantStatus {
  ACTIVE
  REVOKED
}

enum AuditAction {
  CLIENT_CREATED
  CLIENT_UPDATED
  POLICY_CREATED
  POLICY_UPDATED
  BENEFICIARY_CREATED
  BENEFICIARY_UPDATED
  INVITE_CREATED
  INVITE_ACCEPTED
  CLIENT_VIEWED
  CLIENT_SUMMARY_PDF_DOWNLOADED
  POLICY_SEARCH_PERFORMED
  GLOBAL_POLICY_SEARCH_PERFORMED
  DOCUMENT_UPLOADED
  DOCUMENT_PROCESSED
  ATTORNEY_VERIFIED
  API_TOKEN_CREATED
  API_TOKEN_REVOKED
  API_TOKEN_ROTATED
  API_TOKEN_USED
}

enum BillingPlan {
  FREE
  SOLO
  SMALL_FIRM
  ENTERPRISE
}

enum InviteStatus {
  pending
  accepted
  expired
  revoked
}

enum OrgRole {
  OWNER
  ATTORNEY
  STAFF
}

enum UserRole {
  attorney
}

enum LicenseStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REVOKED
}

enum SubmissionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum RegistryStatus {
  ACTIVE
  ARCHIVED
  PENDING_VERIFICATION
  VERIFIED
  DISPUTED
}

enum RegistrySubmissionSource {
  SYSTEM
  ATTORNEY
  INTAKE
}

enum AccessLogAction {
  VIEWED
  CREATED
  UPDATED
  VERIFIED
  ARCHIVED
  EXPORTED
  DELETED
  INTAKE_SUBMITTED
  REGISTRY_UPDATED_BY_TOKEN
  DASHBOARD_VIEW
  REGISTRY_VIEW
  SEARCH_PERFORMED
  ACCESS_REQUESTED
  ACCESS_GRANTED
}

enum PolicyVerificationStatus {
  PENDING
  VERIFIED
  DISCREPANCY
  INCOMPLETE
  REJECTED
}

model submissions {
  id             String            @id
  client_id      String
  invite_id      String?
  status         SubmissionStatus  @default(PENDING)
  submission_type String
  submitted_data Json?
  error_message  String?
  processed_at   DateTime?
  created_at     DateTime          @default(now())
  updated_at     DateTime
  clients        clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  client_invites client_invites?   @relation(fields: [invite_id], references: [id], onDelete: SetNull)
  documents      documents[]
  receipts       receipts[]

  @@index([client_id])
  @@index([invite_id])
  @@index([status])
  @@index([created_at])
}

model receipts {
  id             String            @id
  submission_id  String?
  client_id      String
  invite_id      String?
  receipt_number String            @unique
  pdf_path       String?
  email_sent      Boolean           @default(false)
  email_sent_at  DateTime?
  created_at     DateTime          @default(now())
  clients        clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  client_invites client_invites?   @relation(fields: [invite_id], references: [id], onDelete: SetNull)
  submissions    submissions?      @relation(fields: [submission_id], references: [id], onDelete: Cascade)

  @@index([submission_id])
  @@index([client_id])
  @@index([invite_id])
  @@index([receipt_number])
  @@index([created_at])
}

model client_versions {
  id                  String            @id
  client_id           String
  invite_id           String?
  version_number       Int
  previous_version_id String?
  client_data         Json
  policies_data       Json?
  beneficiaries_data  Json?
  changes             Json?
  submitted_by        String?
  submission_method   String?
  notes               String?
  created_at          DateTime          @default(now())
  clients             clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  client_invites      client_invites?   @relation(fields: [invite_id], references: [id], onDelete: SetNull)

  @@index([client_id])
  @@index([invite_id])
  @@index([version_number])
  @@index([created_at])
  @@index([previous_version_id])
}

model registry_records {
  id            String            @id
  decedent_name String
  status        RegistryStatus    @default(PENDING_VERIFICATION)
  created_at    DateTime          @default(now())
  registry_versions registry_versions[]
  access_logs   access_logs[]

  @@index([decedent_name])
  @@index([status])
  @@index([created_at])
}

model registry_versions {
  id            String                @id
  registry_id   String
  data_json     Json
  submitted_by  RegistrySubmissionSource
  hash          String
  created_at    DateTime              @default(now())
  registry_records registry_records   @relation(fields: [registry_id], references: [id], onDelete: Cascade)
  documents     documents[]

  @@index([registry_id])
  @@index([hash])
  @@index([created_at])
  @@index([submitted_by])
}

model access_logs {
  id         String          @id
  registry_id String
  user_id    String?
  action     AccessLogAction
  metadata   Json?
  timestamp  DateTime        @default(now())
  registry_records registry_records @relation(fields: [registry_id], references: [id], onDelete: Cascade)
  users      User?           @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([registry_id])
  @@index([user_id])
  @@index([timestamp])
  @@index([action])
}
