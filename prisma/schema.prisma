// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  attorney
  client
  admin
}

enum InviteStatus {
  pending
  accepted
  expired
  revoked
}

enum AuditAction {
  CLIENT_CREATED
  CLIENT_UPDATED
  POLICY_CREATED
  POLICY_UPDATED
  BENEFICIARY_CREATED
  BENEFICIARY_UPDATED
  INVITE_CREATED
  INVITE_ACCEPTED
  CLIENT_VIEWED
  CLIENT_SUMMARY_PDF_DOWNLOADED
}

enum AccessGrantStatus {
  ACTIVE
  REVOKED
}

enum OrgRole {
  OWNER
  ATTORNEY
  STAFF
}

enum BillingPlan {
  FREE
  SOLO
  SMALL_FIRM
  ENTERPRISE
}

// User model - synced with Clerk
model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  role      UserRole @default(client)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Organization membership
  orgMemberships OrgMember[]

  // Attorney relationships
  attorneyClientAccess AttorneyClientAccess[] @relation("AttorneyAccess")
  invites               Invite[]              @relation("AttorneyInvites")
  clientInvites         ClientInvite[]         @relation("ClientInviteInviter")
  accessGrants          AccessGrant[]          @relation("AttorneyAccess")

  // Client relationships (if user is a client)
  clientRecord Client? @relation("UserClient")
  auditLogs    AuditLog[]

  @@map("users")
}

// Organization model (Law Firms)
model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  addressLine1 String? @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String?
  phone        String?
  logoUrl      String? @map("logo_url")

  // Billing
  billingPlan          BillingPlan @default(FREE) @map("billing_plan")
  stripeCustomerId     String?     @map("stripe_customer_id")
  stripeSubscriptionId String?     @map("stripe_subscription_id")
  billingStatus        String?     @map("billing_status") // e.g. "active", "past_due", "canceled"

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Organization members
  members OrgMember[]

  // Organization-level relationships
  attorneyClientAccess AttorneyClientAccess[]
  invites               Invite[]
  accessGrants          AccessGrant[]
  clients               Client[] @relation("OrgClients")
  auditLogs             AuditLog[]

  @@map("organizations")
}

// Organization Member - links Users to Organizations
model OrgMember {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           OrgRole  @default(ATTORNEY)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("org_members")
}

// Clients (individuals who have insurance policies)
model Client {
  id          String    @id @default(uuid())
  email       String
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  phone       String?
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Link to User if client has an account
  userId String? @unique @map("user_id")
  user   User?   @relation("UserClient", fields: [userId], references: [id], onDelete: SetNull)

  // Link to Organization (for billing limits)
  orgId String? @map("org_id")
  org   Organization? @relation("OrgClients", fields: [orgId], references: [id], onDelete: SetNull)

  // Relationships
  attorneyAccess AttorneyClientAccess[]
  policies        Policy[]
  beneficiaries   Beneficiary[]
  invites         ClientInvite[]
  accessGrants    AccessGrant[]
  auditLogs       AuditLog[]

  @@map("clients")
}

// Attorney-Client relationships (access control)
model AttorneyClientAccess {
  id             String    @id @default(uuid())
  attorneyId     String    @map("attorney_id")
  clientId       String    @map("client_id")
  organizationId String?   @map("organization_id")
  grantedAt      DateTime  @default(now()) @map("granted_at")
  revokedAt      DateTime? @map("revoked_at")
  isActive       Boolean   @default(true) @map("is_active")

  attorney     User     @relation("AttorneyAccess", fields: [attorneyId], references: [id], onDelete: Cascade)
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([attorneyId, clientId])
  @@map("attorney_client_access")
}

// Invites (Attorney â†’ Client)
model Invite {
  id             String       @id @default(uuid())
  token          String       @unique
  attorneyId     String       @map("attorney_id")
  organizationId String?      @map("organization_id")
  clientEmail    String       @map("client_email")
  status         InviteStatus @default(pending)
  expiresAt      DateTime     @map("expires_at")
  acceptedAt     DateTime?    @map("accepted_at")
  createdAt      DateTime     @default(now()) @map("created_at")

  attorney     User          @relation("AttorneyInvites", fields: [attorneyId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invites")
}

// Insurance Companies
model Insurer {
  id           String    @id @default(uuid())
  name         String
  contactPhone String?   @map("contact_phone")
  contactEmail String?   @map("contact_email")
  website      String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  policies Policy[]

  @@map("insurers")
}

// Policies (NO benefit amounts stored)
model Policy {
  id           String    @id @default(uuid())
  clientId     String    @map("client_id")
  insurerId   String    @map("insurer_id")
  policyNumber String?   @map("policy_number")
  policyType   String?   @map("policy_type") // e.g., 'term', 'whole', 'universal'
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  client       Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  insurer      Insurer               @relation(fields: [insurerId], references: [id], onDelete: Cascade)
  beneficiaries PolicyBeneficiary[]
  auditLogs    AuditLog[]

  @@map("policies")
}

// Beneficiaries
model Beneficiary {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  relationship String?  // e.g., 'spouse', 'child', 'trust'
  email       String?
  phone       String?
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  client    Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policies  PolicyBeneficiary[]

  @@map("beneficiaries")
}

// Policy-Beneficiary relationships (many-to-many)
model PolicyBeneficiary {
  id            String   @id @default(uuid())
  policyId      String   @map("policy_id")
  beneficiaryId String   @map("beneficiary_id")
  createdAt     DateTime @default(now()) @map("created_at")

  policy      Policy      @relation(fields: [policyId], references: [id], onDelete: Cascade)
  beneficiary Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)

  @@unique([policyId, beneficiaryId])
  @@map("policy_beneficiaries")
}

// Client Invites (for inviting clients to complete their registry)
model ClientInvite {
  id            String    @id @default(uuid())
  clientId      String    @map("client_id")
  token         String    @unique
  email         String
  expiresAt     DateTime  @map("expires_at")
  usedAt        DateTime? @map("used_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Optional: track who invited
  invitedByUserId String? @map("invited_by_user_id")
  invitedBy       User?   @relation("ClientInviteInviter", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_invites")
}

// Access Grants (organization-level access to clients)
model AccessGrant {
  id              String            @id @default(uuid())
  clientId        String            @map("client_id")
  orgId           String?           @map("org_id")
  attorneyUserId  String?           @map("attorney_user_id")
  status          AccessGrantStatus
  grantedByUserId String?           @map("granted_by_user_id")
  grantedAt       DateTime          @default(now()) @map("granted_at")
  revokedAt       DateTime?         @map("revoked_at")

  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  org      Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  attorney User?         @relation("AttorneyAccess", fields: [attorneyUserId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([orgId])
  @@index([attorneyUserId])
  @@unique([clientId, orgId])
  @@map("access_grants")
}

// Audit Logs
model AuditLog {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  orgId     String?     @map("org_id")
  clientId  String?     @map("client_id")
  policyId  String?     @map("policy_id")
  action    AuditAction
  message   String
  createdAt DateTime    @default(now()) @map("created_at")

  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  org      Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  client   Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  policy   Policy?       @relation(fields: [policyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([orgId])
  @@index([clientId])
  @@index([policyId])
  @@index([createdAt])
  @@map("audit_logs")
}
