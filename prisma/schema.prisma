generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model access_grants {
  id                 String            @id
  client_id          String
  org_id             String?
  attorney_user_id   String?
  status             AccessGrantStatus
  granted_by_user_id String?
  granted_at         DateTime          @default(now())
  revoked_at         DateTime?
  users              User?             @relation("AttorneyAccess", fields: [attorney_user_id], references: [id], onDelete: Cascade)
  clients            clients           @relation(fields: [client_id], references: [id], onDelete: Cascade)
  organizations      organizations?    @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([client_id, org_id])
  @@index([attorney_user_id])
  @@index([client_id])
  @@index([org_id])
}

model attorney_client_access {
  id              String         @id
  attorney_id     String
  client_id       String
  organization_id String?
  granted_at      DateTime       @default(now())
  revoked_at      DateTime?
  is_active       Boolean        @default(true)
  users           User           @relation("AttorneyAccess", fields: [attorney_id], references: [id], onDelete: Cascade)
  clients         clients        @relation(fields: [client_id], references: [id], onDelete: Cascade)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([attorney_id, client_id])
}

model audit_logs {
  id            String         @id
  user_id       String?
  org_id        String?
  client_id     String?
  policy_id     String?
  action        AuditAction
  message       String
  created_at    DateTime       @default(now())
  clients       clients?       @relation(fields: [client_id], references: [id])
  organizations organizations? @relation(fields: [org_id], references: [id])
  policies      policies?      @relation(fields: [policy_id], references: [id])
  users         User?          @relation(fields: [user_id], references: [id])

  @@index([client_id])
  @@index([created_at])
  @@index([org_id])
  @@index([policy_id])
  @@index([user_id])
}

model beneficiaries {
  id                   String                 @id
  client_id            String
  first_name           String
  last_name            String
  relationship         String?
  email                String?
  phone                String?
  date_of_birth        DateTime?              @db.Date
  created_at           DateTime               @default(now())
  updated_at           DateTime
  // Address fields for beneficiary separation
  address_line1        String?
  address_line2        String?
  city                 String?
  state                String?
  postal_code          String?
  country              String?
  clients              clients                @relation(fields: [client_id], references: [id], onDelete: Cascade)
  policy_beneficiaries policy_beneficiaries[]

  // Index for beneficiary searches by name and DOB
  @@index([first_name, last_name, date_of_birth])
  // Index for beneficiary address searches
  @@index([address_line1, city, state, postal_code])
  // Index for client relationship
  @@index([client_id])
}

model client_invites {
  id                 String    @id
  client_id          String
  token              String    @unique
  email              String
  expires_at         DateTime
  used_at            DateTime?
  created_at         DateTime  @default(now())
  updated_at         DateTime
  invited_by_user_id String?
  clients            clients   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  users              User?     @relation("ClientInviteInviter", fields: [invited_by_user_id], references: [id])
}

model clients {
  id                     String                   @id
  email                  String
  first_name             String
  last_name              String
  phone                  String?
  date_of_birth          DateTime?                @db.Date
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  user_id                String?                  @unique
  org_id                 String?
  drivers_license        String?
  maiden_name            String?
  passport_number        String?
  ssn_last_4             String?
  // Client fingerprint - hash of identifying information to prevent duplicates
  client_fingerprint     String?                  @unique
  // Address fields for separation
  address_line1          String?
  address_line2          String?
  city                   String?
  state                  String?
  postal_code            String?
  country                String?
  access_grants          access_grants[]
  attorney_client_access attorney_client_access[]
  audit_logs             audit_logs[]
  beneficiaries          beneficiaries[]
  client_invites         client_invites[]
  organizations          organizations?           @relation(fields: [org_id], references: [id])
  users                  User?                    @relation("UserClient", fields: [user_id], references: [id])
  documents              documents[]
  policies               policies[]

  // Composite unique constraint: email must be unique per client
  @@unique([email])
  // Index for searching by name and DOB combination
  @@index([first_name, last_name, date_of_birth])
  // Index for searching by address (to identify potential duplicates)
  @@index([address_line1, city, state, postal_code])
  // Index for client fingerprint lookups
  @@index([client_fingerprint])
  // Index for organization separation
  @@index([org_id])
}

model documents {
  id             String    @id
  client_id      String
  policy_id      String?
  file_name      String
  file_type      String
  file_size      Int
  file_path      String
  mime_type      String
  uploaded_via   String?
  extracted_data Json?
  ocr_confidence Float?
  created_at     DateTime  @default(now())
  updated_at     DateTime
  clients        clients   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  policies       policies? @relation(fields: [policy_id], references: [id])

  @@index([client_id])
  @@index([created_at])
  @@index([policy_id])
}

model insurers {
  id            String     @id
  name          String
  contact_phone String?
  contact_email String?
  website       String?
  created_at    DateTime   @default(now())
  updated_at    DateTime
  policies      policies[]
}

model invites {
  id              String         @id
  token           String         @unique
  attorney_id     String
  organization_id String?
  client_email    String
  status          InviteStatus   @default(pending)
  expires_at      DateTime
  accepted_at     DateTime?
  created_at      DateTime       @default(now())
  users           User           @relation("AttorneyInvites", fields: [attorney_id], references: [id], onDelete: Cascade)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

model org_members {
  id              String        @id
  user_id         String
  organization_id String
  role            OrgRole       @default(ATTORNEY)
  created_at      DateTime      @default(now())
  updated_at      DateTime
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  users           User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, organization_id])
}

model organizations {
  id                     String                   @id
  name                   String
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  slug                   String                   @unique
  address_line1          String?
  address_line2          String?
  city                   String?
  state                  String?
  postal_code            String?
  country                String?
  phone                  String?
  logo_url               String?
  billing_plan           BillingPlan              @default(FREE)
  billing_status         String?
  stripe_customer_id     String?
  stripe_subscription_id String?
  access_grants          access_grants[]
  attorney_client_access attorney_client_access[]
  audit_logs             audit_logs[]
  clients                clients[]
  invites                invites[]
  org_members            org_members[]
}

model policies {
  id                   String                 @id
  client_id            String
  insurer_id           String
  policy_number        String?
  policy_type          String?
  created_at           DateTime               @default(now())
  updated_at           DateTime
  audit_logs           audit_logs[]
  documents            documents[]
  clients              clients                @relation(fields: [client_id], references: [id], onDelete: Cascade)
  insurers             insurers               @relation(fields: [insurer_id], references: [id], onDelete: Cascade)
  policy_beneficiaries policy_beneficiaries[]
}

model policy_beneficiaries {
  id             String        @id
  policy_id      String
  beneficiary_id String
  created_at     DateTime      @default(now())
  beneficiaries  beneficiaries @relation(fields: [beneficiary_id], references: [id], onDelete: Cascade)
  policies       policies      @relation(fields: [policy_id], references: [id], onDelete: Cascade)

  @@unique([policy_id, beneficiary_id])
}

model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique @map("clerkId")
  email         String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  role          UserRole @default(attorney)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  barNumber     String?  @map("bar_number")
  // Attorney-specific address fields for separation
  address_line1 String?  @map("address_line1")
  address_line2 String?  @map("address_line2")
  city          String?  @map("city")
  state         String?  @map("state")
  postal_code   String?  @map("postal_code")
  country       String?  @map("country")
  phone         String?  @map("phone")

  // Relations
  orgMemberships       org_members[]
  attorneyClientAccess attorney_client_access[] @relation("AttorneyAccess")
  invites              invites[]                @relation("AttorneyInvites")
  clientInvites        client_invites[]         @relation("ClientInviteInviter")
  accessGrants         access_grants[]          @relation("AttorneyAccess")
  clientRecord         clients?                 @relation("UserClient")
  auditLogs            audit_logs[]

  // Index for attorney name searches
  @@index([firstName, lastName])
  // Index for attorney address searches
  @@index([address_line1, city, state, postal_code])
  @@map("users")
}

enum AccessGrantStatus {
  ACTIVE
  REVOKED
}

enum AuditAction {
  CLIENT_CREATED
  CLIENT_UPDATED
  POLICY_CREATED
  POLICY_UPDATED
  BENEFICIARY_CREATED
  BENEFICIARY_UPDATED
  INVITE_CREATED
  INVITE_ACCEPTED
  CLIENT_VIEWED
  CLIENT_SUMMARY_PDF_DOWNLOADED
  POLICY_SEARCH_PERFORMED
  GLOBAL_POLICY_SEARCH_PERFORMED
  DOCUMENT_UPLOADED
  DOCUMENT_PROCESSED
}

enum BillingPlan {
  FREE
  SOLO
  SMALL_FIRM
  ENTERPRISE
}

enum InviteStatus {
  pending
  accepted
  expired
  revoked
}

enum OrgRole {
  OWNER
  ATTORNEY
  STAFF
}

enum UserRole {
  attorney
}
