generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model access_grants {
  id              String            @id
  clientId        String            @map("client_id")
  orgId           String?           @map("org_id")
  attorneyUserId  String?           @map("attorney_user_id")
  status          AccessGrantStatus
  grantedByUserId String?           @map("granted_by_user_id")
  grantedAt       DateTime          @default(now()) @map("granted_at")
  revokedAt       DateTime?         @map("revoked_at")
  users           User?             @relation("AttorneyAccess", fields: [attorneyUserId], references: [id], onDelete: Cascade)
  clients         clients           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  organizations   organizations?    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([clientId, orgId])
  @@index([attorneyUserId])
  @@index([clientId])
  @@index([orgId])
  @@map("access_grants")
}

model audit_logs {
  id            String         @id
  userId        String?        @map("user_id")
  orgId         String?        @map("org_id")
  clientId      String?        @map("client_id")
  policyId      String?        @map("policy_id")
  action        AuditAction
  message       String
  createdAt     DateTime       @default(now()) @map("created_at")
  clients       clients?       @relation(fields: [clientId], references: [id])
  organizations organizations? @relation(fields: [orgId], references: [id])
  policies      policies?      @relation(fields: [policyId], references: [id])
  users         User?          @relation(fields: [userId], references: [id])

  @@index([clientId])
  @@index([orgId])
  @@index([policyId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model beneficiaries {
  id            String   @id
  clientId      String   @map("client_id")

  firstName     String   @map("first_name")
  lastName      String   @map("last_name")

  relationship  String?
  email         String?
  phone         String?
  dateOfBirth   DateTime? @db.Date @map("date_of_birth")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  addressLine1  String?  @map("address_line1")
  addressLine2  String?  @map("address_line2")
  city          String?
  state         String?
  postalCode    String?  @map("postal_code")
  country       String?

  clients       clients  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policyBeneficiaries policy_beneficiaries[]

  @@index([addressLine1, city, state, postalCode])
  @@index([clientId])
  @@index([firstName, lastName, dateOfBirth])
  @@map("beneficiaries")
}

model client_invites {
  id              String    @id
  clientId        String    @map("client_id")
  token           String    @unique
  email           String
  expiresAt       DateTime  @map("expires_at")
  usedAt          DateTime? @map("used_at")
  created_at      DateTime  @default(now())
  updatedAt       DateTime  @updatedAt @map("updated_at")
  invitedByUserId String?   @map("invited_by_user_id")
  clients         clients   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  users           User?     @relation("ClientInviteInviter", fields: [invitedByUserId], references: [id])

  @@map("client_invites")
}

model clients {
  id                String   @id
  email             String   @unique

  firstName         String   @map("first_name")
  lastName          String   @map("last_name")
  phone             String?
  dateOfBirth       DateTime? @db.Date @map("date_of_birth")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  userId            String?  @unique @map("user_id")
  orgId             String?  @map("org_id")

  driversLicense    String?  @map("drivers_license")
  maidenName        String?  @map("maiden_name")
  passportNumber    String?  @map("passport_number")
  ssnLast4          String?  @map("ssn_last_4")

  clientFingerprint String?  @unique @map("client_fingerprint")

  addressLine1      String?  @map("address_line1")
  addressLine2      String?  @map("address_line2")
  city              String?
  state             String?
  postalCode        String?  @map("postal_code")
  country           String?

  accessGrants      access_grants[]
  attorneyClientAccess attorneyClientAccess[]
  auditLogs         audit_logs[]
  beneficiaries     beneficiaries[]
  clientInvites     client_invites[]
  organizations     organizations? @relation(fields: [orgId], references: [id])
  users             User?          @relation("UserClient", fields: [userId], references: [id])
  documents         documents[]
  policies          policies[]

  @@index([addressLine1, city, state, postalCode])
  @@index([clientFingerprint])
  @@index([orgId])
  @@index([firstName, lastName, dateOfBirth])
  @@map("clients")
}


model documents {
  id            String    @id
  clientId      String    @map("client_id")
  policyId      String?   @map("policy_id")
  fileName      String    @map("file_name")
  fileType      String    @map("file_type")
  fileSize      Int       @map("file_size")
  filePath      String    @map("file_path")
  mimeType      String    @map("mime_type")
  uploadedVia   String?   @map("uploaded_via")
  extractedData Json?     @map("extracted_data")
  ocrConfidence Float?    @map("ocr_confidence")
  created_at    DateTime  @default(now())
  updatedAt     DateTime  @updatedAt @map("updated_at")
  clients       clients   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policies      policies? @relation(fields: [policyId], references: [id])

  @@index([clientId])
  @@index([policyId])
  @@index([created_at])
  @@map("documents")
}

model insurers {
  id           String     @id
  name         String
  contactPhone String?    @map("contact_phone")
  contactEmail String?    @map("contact_email")
  website      String?
  created_at   DateTime   @default(now())
  updatedAt    DateTime   @updatedAt @map("updated_at")
  policies     policies[]

  @@map("insurers")
}

model invites {
  id             String         @id
  token          String         @unique
  attorneyId     String         @map("attorney_id")
  organizationId String?        @map("organization_id")
  clientEmail    String         @map("client_email")
  status         InviteStatus   @default(pending)
  expiresAt      DateTime       @map("expires_at")
  acceptedAt     DateTime?      @map("accepted_at")
  created_at     DateTime       @default(now())
  users          User           @relation("AttorneyInvites", fields: [attorneyId], references: [id], onDelete: Cascade)
  organizations  organizations? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invites")
}

model org_members {
  id             String        @id
  userId         String        @map("user_id")
  organizationId String        @map("organization_id")
  role           OrgRole       @default(ATTORNEY)
  created_at     DateTime      @default(now())
  updatedAt      DateTime      @updatedAt @map("updated_at")
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("org_members")
}

model organizations {
  id                     String                   @id
  name                   String
  created_at             DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt @map("updated_at")
  slug                   String                   @unique
  addressLine1           String?                  @map("address_line1")
  addressLine2           String?                  @map("address_line2")
  city                   String?
  state                  String?
  postalCode             String?                  @map("postal_code")
  country                String?
  phone                  String?
  logoUrl                String?                  @map("logo_url")
  billingPlan            BillingPlan              @default(FREE) @map("billing_plan")
  billingStatus          String?                  @map("billing_status")
  stripeCustomerId       String?                  @map("stripe_customer_id")
  stripeSubscriptionId   String?                  @map("stripe_subscription_id")
  access_grants          access_grants[]
  attorneyClientAccess   attorneyClientAccess[]
  audit_logs             audit_logs[]
  clients                clients[]
  invites                invites[]
  org_members            org_members[]

  @@map("organizations")
}

model policies {
  id                   String                 @id
  clientId             String                 @map("client_id")
  insurerId            String?                @map("insurer_id")
  policyNumber         String?                @map("policy_number")
  policyType           String?                @map("policy_type")
  createdAt            DateTime               @default(now())  @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  carrierConfidence    Float?                 @map("carrier_confidence")
  carrierNameRaw       String?                @map("carrier_name_raw")
  audit_logs           audit_logs[]
  documents            documents[]
  clients              clients                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  insurers             insurers?              @relation(fields: [insurerId], references: [id])
  policy_beneficiaries policy_beneficiaries[]

  @@map("policies")
}

model policy_beneficiaries {
  id            String        @id
  policyId      String        @map("policy_id")
  beneficiaryId String        @map("beneficiary_id")
  created_at    DateTime      @default(now())
  beneficiaries beneficiaries @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  policies      policies      @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, beneficiaryId])
  @@map("policy_beneficiaries")
}

model User {
  id        String   @id @default(uuid())

  clerkId   String   @unique @map("clerkId")
  email     String   @unique

  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")

  role      UserRole @default(attorney)
  roles     String[] @default(["USER"])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  barNumber    String? @map("bar_number")
  addressLine1 String? @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String?
  phone        String?

  accessGrants      access_grants[]  @relation("AttorneyAccess")
  apiTokens         ApiToken[]
  attorneyClientAccess attorneyClientAccess[]
  attorneyProfile   attorneyProfile?
  auditLogs         audit_logs[]
  clientInvites     client_invites[] @relation("ClientInviteInviter")
  clientRecord      clients?         @relation("UserClient")
  invites           invites[]        @relation("AttorneyInvites")
  orgMemberships    org_members[]

  @@index([addressLine1, city, state, postalCode])
  @@index([firstName, lastName])
  @@map("users")

}

model attorneyProfile {
  id                  String        @id @default(uuid())
  userId              String        @unique
  licenseStatus       LicenseStatus @default(PENDING)
  verifiedAt          DateTime?
  appliedAt           DateTime      @default(now())
  created_at          DateTime      @default(now())
  updatedAt           DateTime      @updatedAt @map("updated_at")
  lawFirm             String?       @map("law_firm")
  licenseDocumentName String?       @map("license_document_name")
  licenseDocumentPath String?       @map("license_document_path")
  licenseState        String?       @map("license_state")
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attorney_profiles")
}

model ApiToken {
  id           String    @id @default(uuid())
  name         String
  hash         String    @unique
  scopes       String[]
  createdById  String
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  revokedAt    DateTime?
  lastUsedAt   DateTime?
  lastUsedIp   String?
  lastUsedPath String?
  createdBy    User      @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([expiresAt])
  @@index([revokedAt])
  @@index([lastUsedAt])
  @@map("api_tokens")
}

model attorneyClientAccess {
  id             String   @id

  attorneyId     String   @map("attorney_id")
  clientId       String   @map("client_id")
  organizationId String?  @map("organization_id")

  grantedAt      DateTime @default(now()) @map("granted_at")
  revokedAt      DateTime? @map("revoked_at")
  isActive       Boolean  @default(true) @map("is_active")

  users          User           @relation(fields: [attorneyId], references: [id], onDelete: Cascade)
  clients        clients        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  organizations  organizations? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([attorneyId, clientId])
  @@map("attorney_client_access")
}


enum AccessGrantStatus {
  ACTIVE
  REVOKED
}

enum AuditAction {
  CLIENT_CREATED
  CLIENT_UPDATED
  POLICY_CREATED
  POLICY_UPDATED
  BENEFICIARY_CREATED
  BENEFICIARY_UPDATED
  INVITE_CREATED
  INVITE_ACCEPTED
  CLIENT_VIEWED
  CLIENT_SUMMARY_PDF_DOWNLOADED
  POLICY_SEARCH_PERFORMED
  GLOBAL_POLICY_SEARCH_PERFORMED
  DOCUMENT_UPLOADED
  DOCUMENT_PROCESSED
  ATTORNEY_VERIFIED
  API_TOKEN_CREATED
  API_TOKEN_REVOKED
  API_TOKEN_ROTATED
  API_TOKEN_USED
}

enum BillingPlan {
  FREE
  SOLO
  SMALL_FIRM
  ENTERPRISE
}

enum InviteStatus {
  pending
  accepted
  expired
  revoked
}

enum OrgRole {
  OWNER
  ATTORNEY
  STAFF
}

enum UserRole {
  attorney
}

enum LicenseStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REVOKED
}
